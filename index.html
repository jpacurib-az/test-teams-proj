<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">  
  <meta http-equiv="cache-control" content="no-cache" />
  <meta http-equiv="pragma" content="no-cache" />
  
  <title>Test Teams</title> 
  <style type="text/css">
    span.version {
      font-weight: bold;
    }
    
    textarea {
      width: 80%;
    }
    
    div.hidden {
      display: none;
    }
  </style>
</head>

<body>
  <span class="version">2.0</span>
  
  <div id="STATE.ADD_TO_MTG" class="hidden"> 
    Add POC Meetings Ext to meeting?
  </div>
  
  <div ID="STATE.NONE" class="hidden">
    <textarea id="TEAMS_CONTEXT" placeholder="Teams Context" rows="10"></textarea>  
    <br/>    
    <br/>
    <div class="hidden">
      <textarea id="LOGIN_URL" placeholder="Login URL" rows="5"></textarea>
      <br/>
      <button onclick="doLoginNormal()">Login Normal</button>
      <button onclick="doLoginTeamsSdk()">Login with Teams SDK</button>
      <br/>
      <br/>
      <textarea id="RESULT" placeholder="Login Result" rows="1"></textarea>
      <br/>  
      <br/>  
    </div>
    <textarea id="USER_TOKEN" placeholder="User Token" rows="10"></textarea>
    <br/>
    <br/>
    <textarea id="JS_CODE" placeholder="JS Code" rows="7"></textarea>
    <br/>
    <button onclick="execCode()">Execute Code</button>    
    <br/>
    <img src="data:image/gif;base64,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" />    
  </div>
  
</body>
  
  <script src="https://statics.teams.microsoft.com/sdk/v1.5.2/js/MicrosoftTeams.min.js" crossorigin="anonymous"></script>  
  
  <script type="text/javascript">   
  
    function init() {
      microsoftTeams.initialize();      
      doSSO();
      
      var globalUrl = new URL(window.location.href);
      var state = globalUrl.searchParams.get("state");
      
      if (state === "add_to_mtg") {
        microsoftTeams.settings.registerOnSaveHandler(function(saveEvent) {
          var url = "https://jpacurib-az.github.io/test-teams-proj";
          microsoftTeams.settings.setSettings({
            "suggestedDisplayName": "Meeting app",
            "entityId": "Test",
            "contentUrl": url,
            "websiteUrl": url
          });        
          saveEvent.notifySuccess();
        });
        
        microsoftTeams.settings.setValidityState(true);
        document.getElementById("STATE.ADD_TO_MTG").classList.remove("hidden");
        return;
      }
      
      microsoftTeams.getContext(function(ctx) {              
        document.getElementById("TEAMS_CONTEXT").value = JSON.stringify(ctx, null, 2);
      });
      
      var sampleUrl = "https://login.microsoftonline.com/64e0e568-dc64-419f-958f-82e4565a24da/oauth2/v2.0/authorize?login_hint=jaysonne_pacurib%40azeusdeveloper.onmicrosoft.com&scope=openid+profile+offline_access+User.Read+Sites.ReadWrite.All+Files.ReadWrite.All+Calendars.ReadWrite+OnlineMeetings.ReadWrite&response_type=code&redirect_uri=http%3A%2F%2Flocalhost%3A8080%2F1.0%2Fapi%2Faccept-auth&state=%7B%22requestId%22%3A%22U001-001-002%22%2C%22componentId%22%3A%22json-test-app%22%2C%22userId%22%3A%22842a7b94-0c01-403f-a347-6181382854f4%22%2C%22redirectUri%22%3A%22https%3A%2F%2Fjpacurib-az.github.io%2Ftest-teams-proj%2F404.html%22%7D&nonce=c7d30cdd-6353-4a3a-9deb-f22a8c7805cb&client_id=66af5ea4-f904-4597-9e96-92eff924ba00&response_mode=query";  
      document.getElementById("LOGIN_URL").value = sampleUrl;
      document.getElementById("STATE.NONE").classList.remove("hidden");
    }
    
    function doSSO() {
      var authTokenRequest = {
        successCallback: function(result) {
          var displayToken = null;
          try {
            displayToken = JSON.stringify(parseJwt(result), null, 2);
          } catch (err) {
            displayToken = err;
          }        
          document.getElementById("USER_TOKEN").value = displayToken;
        },
        failureCallback: function(error) {           
          document.getElementById("USER_TOKEN").value = error;
        }
      };
      microsoftTeams.authentication.getAuthToken(authTokenRequest);
    }
    
    function parseJwt (token) {
      var base64Url = token.split('.')[1];
      var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
          return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }
  
    function doLoginNormal() {
      var thisUrl = document.getElementById("LOGIN_URL").value;
      if (!thisUrl) {
        alert("No URL value");
        return;
      }
      
      document.getElementById("RESULT").value = "";
      window.location.href = thisUrl;
    }  
  
    function doLoginTeamsSdk() {
      var thisUrl = document.getElementById("LOGIN_URL").value;
      if (!thisUrl) {
        alert("No URL value");
        return;
      }
      
      document.getElementById("RESULT").value = "";
      var startUrl = "https://jpacurib-az.github.io/test-teams-proj/404.html?start=" + encodeURIComponent(thisUrl);
      console.log(startUrl);
    
      microsoftTeams.authentication.authenticate({
        url: startUrl,
        width: 800,
        height: 600,
        successCallback: function(result) { grabResult(result); },
        failureCallback: function(result) { grabResult(result); }
      });      
    }
    
    function grabResult(result) {
      console.log(result);
      var userId = localStorage.getItem("MS_ADAPTER_LOGIN_RESULT.USER_ID");
      var requestId = localStorage.getItem("MS_ADAPTER_LOGIN_RESULT.REQUEST_ID");
      
      var msg = "userId: " + userId 
              + "\n"
              + "requestId: " + requestId;
      
      document.getElementById("RESULT").value = msg;
      localStorage.clear("MS_ADAPTER_LOGIN_RESULT.USER_ID");
      localStorage.clear("MS_ADAPTER_LOGIN_RESULT.REQUEST_ID");
    }
    
    function execCode() {
      var code = document.getElementById("JS_CODE").value;
      if (!code) {
        alert("No code to execute");
        return;
      }
      eval(code);
    }
  
  init();
  </script>
</html>
