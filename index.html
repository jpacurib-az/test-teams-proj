<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">  
  <meta http-equiv="cache-control" content="no-cache" />
  <meta http-equiv="pragma" content="no-cache" />
  
  <title>Test Teams</title> 
  <style type="text/css">
    span.version {
      font-weight: bold;
    }
    
    textarea {
      width: 80%;
    }
    
    div.hidden {
      display: none;
    }
  </style>
</head>

<body>
  <span class="version">1.9</span>
  
  <div id="STATE.ADD_TO_MTG" class="hidden"> 
    Add POC Meetings Ext to meeting?
  </div>
  
  <div ID="STATE.NONE" class="hidden">
    <textarea id="TEAMS_CONTEXT" placeholder="Teams Context" rows="15"></textarea>  
    <br/>    
    <br/>
    <textarea id="LOGIN_URL" placeholder="Login URL" rows="5"></textarea>
    <br/>
    <button onclick="doLoginNormal()">Login Normal</button>
    <button onclick="doLoginTeamsSdk()">Login with Teams SDK</button>
    <br/>
    <br/>
    <textarea id="RESULT" placeholder="Login Result" rows="5"></textarea>
    <br/>  
    <br/>
    <textarea id="JS_CODE" placeholder="JS Code" rows="7"></textarea>
    <br/>
    <button onclick="execCode()">Execute Code</button>    
  </div>
  
</body>
  
  <script src="https://statics.teams.microsoft.com/sdk/v1.5.2/js/MicrosoftTeams.min.js" crossorigin="anonymous"></script>  
  
  <script type="text/javascript">   
  
    function init() {
      microsoftTeams.initialize();  
      
      var globalUrl = new URL(window.location.href);
      var state = globalUrl.searchParams.get("state");
      
      if (state === "add_to_mtg") {
        microsoftTeams.settings.registerOnSaveHandler(function(saveEvent) {
          var url = "https://jpacurib-az.github.io/test-teams-proj";
          microsoftTeams.settings.setSettings({
            "suggestedDisplayName": "Meeting app",
            "entityId": "Test",
            "contentUrl": url,
            "websiteUrl": url
          });        
          saveEvent.notifySuccess();        
        });
        
        microsoftTeams.settings.setValidityState(true);
        document.getElementById("STATE.ADD_TO_MTG").classList.remove("hidden");
        return;
      }
      
      microsoftTeams.getContext(function(ctx) {              
        document.getElementById("TEAMS_CONTEXT").value = JSON.stringify(ctx, null, 2);
      });
      
      var sampleUrl = "https://login.microsoftonline.com/64e0e568-dc64-419f-958f-82e4565a24da/oauth2/v2.0/authorize?login_hint=jaysonne_pacurib%40azeusdeveloper.onmicrosoft.com&scope=openid+profile+offline_access+User.Read+Sites.ReadWrite.All+Files.ReadWrite.All+Calendars.ReadWrite+OnlineMeetings.ReadWrite&response_type=code&redirect_uri=http%3A%2F%2Flocalhost%3A8080%2F1.0%2Fapi%2Faccept-auth&state=%7B%22requestId%22%3A%22U001-001-002%22%2C%22componentId%22%3A%22json-test-app%22%2C%22userId%22%3A%22842a7b94-0c01-403f-a347-6181382854f4%22%2C%22redirectUri%22%3A%22https%3A%2F%2Fjpacurib-az.github.io%2Ftest-teams-proj%2F404.html%22%7D&nonce=c7d30cdd-6353-4a3a-9deb-f22a8c7805cb&client_id=66af5ea4-f904-4597-9e96-92eff924ba00&response_mode=query";  
      document.getElementById("LOGIN_URL").value = sampleUrl;
      document.getElementById("STATE.NONE").classList.remove("hidden");
    }
  
    function doLoginNormal() {
      var thisUrl = document.getElementById("LOGIN_URL").value;
      if (!thisUrl) {
        alert("No URL value");
        return;
      }
      
      document.getElementById("RESULT").value = "";
      window.location.href = thisUrl;
    }  
  
    function doLoginTeamsSdk() {
      var thisUrl = document.getElementById("LOGIN_URL").value;
      if (!thisUrl) {
        alert("No URL value");
        return;
      }
      
      document.getElementById("RESULT").value = "";
      var startUrl = "https://jpacurib-az.github.io/test-teams-proj/404.html?start=" + encodeURIComponent(thisUrl);
      console.log(startUrl);
    
      microsoftTeams.authentication.authenticate({
        url: startUrl,
        width: 800,
        height: 600,
        successCallback: function(result) { grabResult(result); },
        failureCallback: function(result) { grabResult(result); }
      });      
    }
    
    function grabResult(result) {
      console.log(result);
      var userId = localStorage.getItem("MS_ADAPTER_LOGIN_RESULT.USER_ID");
      var requestId = localStorage.getItem("MS_ADAPTER_LOGIN_RESULT.REQUEST_ID");
      
      var msg = "userId: " + userId 
              + "\n"
              + "requestId: " + requestId;
      
      document.getElementById("RESULT").value = msg;
      localStorage.clear("MS_ADAPTER_LOGIN_RESULT.USER_ID");
      localStorage.clear("MS_ADAPTER_LOGIN_RESULT.REQUEST_ID");
    }
    
    function execCode() {
      var code = document.getElementById("JS_CODE").value;
      if (!code) {
        alert("No code to execute");
        return;
      }
      eval(code);
    }
  
  init();
  </script>
</html>
